<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Net‑Worth Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind via CDN for quick styling -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-slate-100 flex flex-col items-center p-6">
<main class="w-full max-w-5xl">
    <!-- Banner -->
    <header class="mb-6">
        <h1 class="text-3xl font-bold text-slate-800 mb-1">Net‑Worth Tracker</h1>
        <p class="text-lg text-slate-700">Current Net‑Worth:
            <span id="networth" class="font-semibold text-emerald-600">$0</span>
        </p>
    </header>

    <div class="grid gap-6 md:grid-cols-2">
        <!-- Add asset card -->
        <section class="bg-white shadow rounded-xl p-6">
            <h2 class="text-xl font-semibold mb-4 text-slate-700">Add Asset</h2>
            <form id="assetForm" class="space-y-4">
                <input id="name" type="text" placeholder="Ticker (e.g. VTI)" required
                       class="w-full border rounded-md p-2" />

                <select id="category" class="w-full border rounded-md p-2">
                    <option value="STOCK">Stock</option>
                    <option value="CRYPTO">Crypto</option>
                    <option value="CASH">Cash</option>
                    <option value="OTHER">Other</option>
                </select>

                <div class="grid gap-4 md:grid-cols-2">
                    <input id="units" type="number" step="any" placeholder="Shares" required
                           class="flex-1 border rounded-md p-2" />
                    <input id="purchasePrice" type="number" step="any" placeholder="Purchase Price" required
                           class="flex-1 border rounded-md p-2" />
                </div>

                <button type="submit"
                        class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-2 rounded-md transition">
                    Add Asset
                </button>
            </form>
            <p id="error" class="text-red-600 mt-3"></p>
        </section>

        <!-- Asset table card -->
        <section class="bg-white shadow rounded-xl p-6 overflow-x-auto md:col-span-1 md:row-span-2">
            <h2 class="text-xl font-semibold mb-4 text-slate-700">Assets</h2>
            <table class="min-w-full text-sm">
                <thead class="bg-slate-200">
                <tr>
                    <th class="py-2 px-3 text-left">Name</th>
                    <th class="py-2 px-3 text-left">Category</th>
                    <th class="py-2 px-3 text-left" id="unitsHeader">Shares</th>
                    <th class="py-2 px-3 text-left">Purchase</th>
                    <th class="py-2 px-3 text-left">Market</th>
                    <th class="py-2 px-3 text-left">Gain</th>
                    <th class="py-2 px-3 text-left">Updated</th>
                    <th class="py-2 px-3"></th>
                </tr>
                </thead>
                <tbody id="assetRows" class="divide-y divide-slate-100"></tbody>
            </table>
        </section>
    </div>
</main>

<script>
    const rows         = document.getElementById('assetRows');
    const networthEl   = document.getElementById('networth');
    const errorEl      = document.getElementById('error');
    const categorySel  = document.getElementById('category');
    const unitsInput   = document.getElementById('units');
    const unitsHeader  = document.getElementById('unitsHeader');

    const unitLabels = { STOCK: 'Shares', CRYPTO: 'Coins', CASH: 'Units', OTHER: 'Units' };

    // swap placeholder/heading when category changes
    categorySel.addEventListener('change', () => {
        const label = unitLabels[categorySel.value] || 'Units';
        unitsInput.placeholder = label;
        unitsHeader.textContent = label;
    });

    /* --------------- fetch helpers --------------- */
    async function loadAssets() {
        const res = await fetch('/api/assets');
        const assets = await res.json();
        rows.innerHTML = '';
        assets.forEach(a => addRow(a));
    }

    async function loadNetworth() {
        const res = await fetch('/api/assets/networth');
        const total = await res.text();
        networthEl.textContent = Number(total).toLocaleString(undefined,{maximumFractionDigits:2});
    }

    async function removeAsset(id) {
        await fetch('/api/assets/'+id, {method:'DELETE'});
        await loadAssets();
        await loadNetworth();
    }

    /* --------------- UI builders --------------- */
    function addRow(a) {
        const tr = document.createElement('tr');
        const unitLabel = unitLabels[a.category] || 'Units';
        const gain = (a.unitValue - a.purchasePrice) * a.units;
        const gainClass = gain >= 0 ? 'text-emerald-600' : 'text-red-600';
        tr.innerHTML = `\n        <td class="py-2 px-3">${a.name}</td>\n        <td class="py-2 px-3">${a.category}</td>\n        <td class="py-2 px-3">${a.units} ${unitLabel.toLowerCase()}</td>\n        <td class="py-2 px-3">${a.purchasePrice}</td>\n        <td class="py-2 px-3">${a.unitValue}</td>\n        <td class="py-2 px-3 ${gainClass}">${gain.toFixed(2)}</td>\n        <td class="py-2 px-3">${a.updated ? a.updated.replace('T',' ').split('.')[0] : ''}</td>\n        <td class="py-2 px-3"><button class="text-red-600 hover:underline" data-id="${a.id}">Delete</button></td>`;
        tr.querySelector('button').addEventListener('click', () => removeAsset(a.id));
        rows.appendChild(tr);
    }

    function showError(msg){
        errorEl.textContent = msg;
        setTimeout(()=>errorEl.textContent='', 4000);
    }

    /* --------------- form submit --------------- */
    document.getElementById('assetForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        errorEl.textContent='';
        const body = {
            name: document.getElementById('name').value.trim(),
            category: categorySel.value,
            units: document.getElementById('units').value,
            purchasePrice: document.getElementById('purchasePrice').value,
            unitValue: 0 // backend will overwrite after first refresh
        };

        // inline validation
        if(!body.name) return showError('Name required');
        if(body.units <= 0) return showError('Units must be > 0');
        if(body.purchasePrice < 0) return showError('Purchase price ≥ 0');

        const res = await fetch('/api/assets', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(body)
        });
        if(res.ok){
            e.target.reset();
            categorySel.value = 'STOCK';
            unitsInput.placeholder = 'Shares';
            unitsHeader.textContent = 'Shares';
            await loadAssets();
            await loadNetworth();
        } else {
            const data = await res.json().catch(()=>null);
            showError((data && data.errors) ? JSON.stringify(data.errors) : 'Error adding asset');
        }
    });

    /* --------------- initial fetch --------------- */
    loadAssets();
    loadNetworth();
</script>
</body>
</html>
